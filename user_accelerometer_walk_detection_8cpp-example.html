<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>ESP: user_accelerometer_walk_detection.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ESP
   &#160;<span id="projectnumber">0.1</span>
   </div>
   <div id="projectbrief">The Example-based Sensor Predictions (ESP) system tries to bring machine learning to the maker community.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('user_accelerometer_walk_detection_8cpp-example.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">user_accelerometer_walk_detection.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>Simple walk detection using an accelerometer. This uses a very simple algorithm: thresholding the standard deviation of energy (dot product) of the acceleration vector over a history of samples. The choice of this algorithm is based on the discussion in "Walk detection and step counting on
unconstrained smartphones" by Agata Brajdic and Robert Harle <a href="http://dl.acm.org/citation.cfm?id=2493449">http://dl.acm.org/citation.cfm?id=2493449</a> which suggests that this is as good (or better) than more complex methods.</p>
<p>To use, upload the Arduino101_Accelerometer_100Hz to an Arduino 101. After calibration, place the Arduino 101 in a front pants pocket.</p>
<p>It's certainly possible to fool this algorithm into thinking that you are walking when you aren't (e.g. by jumping up and down). It also might require lowering of the threshold to detect slow walking. But, in general, this should be at least useful for experimenting.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="_e_s_p_8h.html">ESP.h</a>&gt;</span></div><div class="line"></div><div class="line"><a name="_a0"></a><a class="code" href="class_a_s_c_i_i_serial_stream.html">ASCIISerialStream</a> <a name="a1"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#a41a00af8a6d249ec09dea539956386f2">stream</a>(9600, 3);</div><div class="line">GestureRecognitionPipeline <a name="a2"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#ad04a77e9fb154385d1f97731437390e4">pipeline</a>;</div><div class="line"><a name="_a3"></a><a class="code" href="class_calibrator.html">Calibrator</a> <a name="a4"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#a2dfd966029091cbf3bc049ece6a957ce">calibrator</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">double</span> <a name="a5"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#addc7ddd3b45227e1cd1b2c862a63534a">zeroG</a> = 0, <a name="a6"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#a6423f81bc2d048133f946ad3c0c22aaf">oneG</a> = 0;</div><div class="line"></div><div class="line"><span class="keywordtype">double</span> <a name="a7"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#add00571ce8cfd3623ea0967ad8b24b89">processAccelerometerData</a>(<span class="keywordtype">double</span> input)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> (input - <a class="code" href="user__accelerometer__walk__detection_8cpp.html#addc7ddd3b45227e1cd1b2c862a63534a">zeroG</a>) / (<a class="code" href="user__accelerometer__walk__detection_8cpp.html#a6423f81bc2d048133f946ad3c0c22aaf">oneG</a> - <a class="code" href="user__accelerometer__walk__detection_8cpp.html#addc7ddd3b45227e1cd1b2c862a63534a">zeroG</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><a name="_a8"></a><a class="code" href="class_calibrate_result.html">CalibrateResult</a> <a name="a9"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#ad5dcfc15f7ade75a4d1ee00ff9bbf4c4">restingDataCollected</a>(<span class="keyword">const</span> MatrixDouble&amp; data)</div><div class="line">{</div><div class="line">    <span class="comment">// take average of X and Y acceleration as the zero G value</span></div><div class="line">    <a class="code" href="user__accelerometer__walk__detection_8cpp.html#addc7ddd3b45227e1cd1b2c862a63534a">zeroG</a> = (data.getMean()[0] + data.getMean()[1]) / 2;</div><div class="line">    <a class="code" href="user__accelerometer__walk__detection_8cpp.html#a6423f81bc2d048133f946ad3c0c22aaf">oneG</a> = data.getMean()[2]; <span class="comment">// use Z acceleration as one G value</span></div><div class="line">    </div><div class="line">    <span class="keywordtype">double</span> <a name="a10"></a><a class="code" href="user__audio_8cpp.html#ac26a49438fb4be02f746d15833a9c591">range</a> = abs(<a class="code" href="user__accelerometer__walk__detection_8cpp.html#a6423f81bc2d048133f946ad3c0c22aaf">oneG</a> - <a class="code" href="user__accelerometer__walk__detection_8cpp.html#addc7ddd3b45227e1cd1b2c862a63534a">zeroG</a>);</div><div class="line">    vector&lt;double&gt; <a name="a11"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#ad4b4c1ac691d1a176bb01bd3a3b7f74d">stddev</a> = data.getStdDev();</div><div class="line">    </div><div class="line">    <span class="keywordflow">if</span> (stddev[0] / range &gt; 0.05 ||</div><div class="line">        stddev[1] / range &gt; 0.05 ||</div><div class="line">        stddev[2] / range &gt; 0.05)</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="class_calibrate_result.html">CalibrateResult</a>(<a name="a12"></a><a class="code" href="class_calibrate_result.html#aa473de26f2f0bc502e58b7ebdb038e4ba4fc1d1c38fcfbb9fe85e5f0b6222bfee">CalibrateResult::WARNING</a>,</div><div class="line">            <span class="stringliteral">&quot;Accelerometer seemed to be moving; consider recollecting the &quot;</span></div><div class="line">            <span class="stringliteral">&quot;calibration sample.&quot;</span>);</div><div class="line">    </div><div class="line">    <span class="keywordflow">if</span> (abs(data.getMean()[0] - data.getMean()[1]) / range &gt; 0.1)</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="class_calibrate_result.html">CalibrateResult</a>(<a class="code" href="class_calibrate_result.html#aa473de26f2f0bc502e58b7ebdb038e4ba4fc1d1c38fcfbb9fe85e5f0b6222bfee">CalibrateResult::WARNING</a>,</div><div class="line">            <span class="stringliteral">&quot;X and Y axes differ by &quot;</span> + std::to_string(</div><div class="line">            abs(data.getMean()[0] - data.getMean()[1]) / range * 100) +</div><div class="line">            <span class="stringliteral">&quot; percent. Check that accelerometer is flat.&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <a name="a13"></a><a class="code" href="class_calibrate_result.html#aa473de26f2f0bc502e58b7ebdb038e4baf73ac5d463abf48767fe0270f33f99e3">CalibrateResult::SUCCESS</a>;</div><div class="line">}</div><div class="line"></div><div class="line">VectorDouble <a name="a14"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#a1730ef96f862bdaffdadbfc620efbc4f">dotProduct</a>(VectorDouble in)</div><div class="line">{</div><div class="line">    VectorDouble out(1, 0);</div><div class="line">    </div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; in.size(); i++)</div><div class="line">        out[0] += in[i] * in[i];</div><div class="line">    </div><div class="line">    <span class="keywordflow">return</span> out;</div><div class="line">}</div><div class="line"></div><div class="line">VectorDouble <a class="code" href="user__accelerometer__walk__detection_8cpp.html#ad4b4c1ac691d1a176bb01bd3a3b7f74d">stddev</a>(VectorDouble v) {</div><div class="line">    <span class="keywordtype">double</span> sum = std::accumulate(v.begin(), v.end(), 0.0);</div><div class="line">    <span class="keywordtype">double</span> mean = sum / v.size();</div><div class="line"></div><div class="line">    <span class="keywordtype">double</span> sq_sum = std::inner_product(v.begin(), v.end(), v.begin(), 0.0);</div><div class="line">    <span class="keywordtype">double</span> stdev = std::sqrt(sq_sum / v.size() - mean * mean);</div><div class="line">    </div><div class="line">    <span class="keywordflow">return</span> VectorDouble(1, stdev);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">double</span> <a name="a15"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#a87accd1af8e0aff4b818d891374f7cec">t</a> = 0.6;</div><div class="line">VectorDouble <a name="a16"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#a89a39fb6802608a79f311f8275a04035">threshold</a>(VectorDouble in) {</div><div class="line">    VectorDouble out(in.size());</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; in.size(); i++)</div><div class="line">        out[i] = (in[i] &gt; t) ? 1.0 : 0.0;</div><div class="line">    <span class="keywordflow">return</span> out;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a name="a17"></a><a class="code" href="user__accelerometer__walk__detection_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a>()</div><div class="line">{</div><div class="line">    <a class="code" href="user__accelerometer__walk__detection_8cpp.html#a41a00af8a6d249ec09dea539956386f2">stream</a>.<a name="a18"></a><a class="code" href="class_i_stream.html#a0a93867f357d27965885fcd36252471f">setLabelsForAllDimensions</a>({<span class="stringliteral">&quot;x&quot;</span>, <span class="stringliteral">&quot;y&quot;</span>, <span class="stringliteral">&quot;z&quot;</span>});</div><div class="line">    <a name="a19"></a><a class="code" href="iostream_8cpp.html#aff979b7370726d96aac43c99e3f7af10">useStream</a>(<a class="code" href="user__accelerometer__walk__detection_8cpp.html#a41a00af8a6d249ec09dea539956386f2">stream</a>);</div><div class="line"></div><div class="line">    calibrator.<a name="a20"></a><a class="code" href="class_calibrator.html#a2dcb738b2c6dcd26184bbd5dba524ac9">setCalibrateFunction</a>(<a class="code" href="user__accelerometer__walk__detection_8cpp.html#add00571ce8cfd3623ea0967ad8b24b89">processAccelerometerData</a>);</div><div class="line">    calibrator.<a name="a21"></a><a class="code" href="class_calibrator.html#a27da214053913c9e19494773ee883ee5">addCalibrateProcess</a>(<span class="stringliteral">&quot;Resting&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;Rest accelerometer on flat surface.&quot;</span>, <a class="code" href="user__accelerometer__walk__detection_8cpp.html#ad5dcfc15f7ade75a4d1ee00ff9bbf4c4">restingDataCollected</a>);</div><div class="line">    <a name="a22"></a><a class="code" href="calibrator_8cpp.html#aa56b17a8db41c36d20d29c360cd4b5bd">useCalibrator</a>(calibrator);</div><div class="line"></div><div class="line">    <a class="code" href="user__accelerometer__walk__detection_8cpp.html#ad04a77e9fb154385d1f97731437390e4">pipeline</a>.addFeatureExtractionModule(FeatureApply(3, 1, <a class="code" href="user__accelerometer__walk__detection_8cpp.html#a1730ef96f862bdaffdadbfc620efbc4f">dotProduct</a>));</div><div class="line">    <a class="code" href="user__accelerometer__walk__detection_8cpp.html#ad04a77e9fb154385d1f97731437390e4">pipeline</a>.addFeatureExtractionModule(TimeseriesBuffer(80, 1));</div><div class="line">    <a class="code" href="user__accelerometer__walk__detection_8cpp.html#ad04a77e9fb154385d1f97731437390e4">pipeline</a>.addFeatureExtractionModule(FeatureApply(80, 1, stddev));</div><div class="line">    <a class="code" href="user__accelerometer__walk__detection_8cpp.html#ad04a77e9fb154385d1f97731437390e4">pipeline</a>.addFeatureExtractionModule(FeatureApply(1, 1, <a class="code" href="user__accelerometer__walk__detection_8cpp.html#a89a39fb6802608a79f311f8275a04035">threshold</a>));</div><div class="line">    <a name="a23"></a><a class="code" href="istream_8cpp.html#a4e89d8b7f053b8e3f5855d084164b39a">usePipeline</a>(<a class="code" href="user__accelerometer__walk__detection_8cpp.html#ad04a77e9fb154385d1f97731437390e4">pipeline</a>);</div><div class="line">    </div><div class="line">    <a name="a24"></a><a class="code" href="tuneable_8cpp.html#a4186bf4ee77f5cfdc19607e41d2abf50">registerTuneable</a>(t, 0, 1.0, <span class="stringliteral">&quot;Walking Threshold&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;How much the accelerometer data needs to be &quot;</span></div><div class="line">        <span class="stringliteral">&quot;changing to be considered walking.&quot;</span>);</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
